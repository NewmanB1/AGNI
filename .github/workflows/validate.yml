name: OLS Validator

on:
  push:
    paths:
      - 'lessons/**'
      - 'schemas/**'
      - 'fixtures/**'
      - '.github/workflows/**'
  pull_request:

jobs:
  validate_all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        # We install the library 'js-yaml' and the tool 'ajv-cli'
        run: npm install js-yaml ajv-cli

      # --- PART 1: VALIDATE LESSONS (.yaml) ---
      - name: Validate Lessons (OLS Schema)
        run: |
          echo "üîç Starting Lesson Validation..."
          
          for lesson in lessons/*.yaml; do
            echo "Checking $lesson..."
            
            # 1. Convert YAML to JSON using a one-line Node script
            # This is safer than relying on external CLI tools
            node -e 'const fs=require("fs"); const yaml=require("js-yaml"); console.log(JSON.stringify(yaml.load(fs.readFileSync(process.argv[1], "utf8"))))' "$lesson" > temp.json
            
            # 2. Validate using npx (executes the local ajv-cli)
            npx ajv validate -s schemas/ols.schema.json -d temp.json
            
            if [ $? -ne 0 ]; then
              echo "‚ùå Validation FAILED for $lesson"
              exit 1
            fi
            echo "‚úÖ $lesson is Valid"
          done
          
          rm temp.json

      # --- PART 2: VALIDATE GRAPH WEIGHTS (.json) ---
      - name: Validate Graph Fixtures
        run: |
          echo "üîç Checking Graph Weights..."
          
          # No conversion needed, it's already JSON
          npx ajv validate -s schemas/graph_weights.schema.json -d fixtures/graph_weaver.json
          
          if [ $? -ne 0 ]; then
             echo "‚ùå Graph Fixture Invalid"
             exit 1
          fi
          echo "‚úÖ Graph Fixture is Valid"
